{{/* Hugo Blox Logger: centralized logging helper
   Usage: partial "functions/logger" (dict "page" . "level" "warn" "message" (printf "..." args...))
   - level: "warn" (default) or "error"
   - page: optional; current page. Defaults to dot. Used to detect adapter pages
   - adapter: optional bool to force adapter-safe mode (e.g., from _content.gotmpl)
*/}}
{{- $level := lower (.level | default "warn") -}}
{{- $msg := (.message | default "" | string) -}}
{{- $page := .page | default . -}}
{{- $forceAdapter := .adapter | default false -}}
{{- $isDev := or hugo.IsServer (eq hugo.Environment "development") -}}

{{/* Detect adapter-generated pages via explicit flag or page param */}}
{{- $isAdapter := $forceAdapter -}}
{{- if not $isAdapter -}}
  {{- with $page -}}
    {{- with .Params -}}
      {{- if or (index . "hb_adapter") (eq (printf "%T" .) "map[string]interface {}" | and (index . "hb_adapter")) -}}
        {{- $isAdapter = true -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* Store log entry for future debug widget */}}
{{- with $page -}}
  {{- $log_entry := dict "level" $level "message" $msg "page" ($.RelPermalink | default "/") "timestamp" now.Unix -}}
  {{- $current_logs := .Store.Get "hbx_logs" | default slice -}}
  {{- .Store.Set "hbx_logs" ($current_logs | append $log_entry) -}}
{{- end -}}

{{/* Multi-tier logging output */}}
{{- if $isDev -}}
  {{/* Console logging for immediate dev feedback */}}
  <script>console.log('[HBX:{{ $level }}]', {{ $msg | jsonify }});</script>
{{- end -}}

{{/* Ensure message is safely converted to string */}}
{{- $safeMsg := "" -}}
{{- if $msg -}}
  {{- $safeMsg = ($msg | string | replaceRE "%" "%%" | replaceRE "\n" " " | replaceRE "\t" " ") -}}
{{- end -}}

{{- if eq $level "error" -}}
  {{- if not $isAdapter -}}
    {{- if $safeMsg -}}
      {{- errorf $safeMsg -}}
    {{- else -}}
      {{- errorf "HBX: Empty error message" -}}
    {{- end -}}
  {{- else -}}
    {{- if $isDev -}}<!-- HBX log:error: {{ $safeMsg }} -->{{- end -}}
  {{- end -}}
{{- else -}}
  {{- if not $isAdapter -}}
    {{- if $safeMsg -}}
      {{- warnf $safeMsg -}}
    {{- else -}}
      {{- warnf "HBX: Empty warning message" -}}
    {{- end -}}
  {{- else -}}
    {{- if $isDev -}}<!-- HBX log:warn: {{ $safeMsg }} -->{{- end -}}
  {{- end -}}
{{- end -}}
{{- "" -}}
