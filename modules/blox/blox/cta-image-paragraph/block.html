{{/* Hugo Blox: CTA Image Paragraph */}}
{{/* Documentation: https://hugoblox.com/blocks/ */}}
{{/* License: https://github.com/HugoBlox/kit/blob/main/LICENSE.md */}}

{{/* Initialise */}}
{{ $page := .wcPage }}
{{ $block := .wcBlock }}
{{ $content := $block.content }}
{{ if not (reflect.IsMap $content) }}{{ $content = dict }}{{ end }}

<div>
  {{ $items_raw := index $content "items" }}
  {{ $items := slice }}
  {{ if reflect.IsSlice $items_raw }}
    {{ $items = $items_raw }}
  {{ else if and $items_raw (reflect.IsMap $items_raw) }}
    {{ $items = slice $items_raw }}
  {{ end }}

  {{ range $idx, $item := $items }}
  {{ if reflect.IsMap $item }}
  {{ $title := "" }}
  {{ $title_raw := index $item "title" }}
  {{ if eq (printf "%T" $title_raw) "string" }}{{ $title = $title_raw | emojify | $page.RenderString }}{{ end }}
  {{ $text := "" }}
  {{ $text_raw := index $item "text" }}
  {{ if eq (printf "%T" $text_raw) "string" }}{{ $text = $text_raw | emojify | $page.RenderString }}{{ end }}
  {{ $image_name := "" }}
  {{ $image_raw := index $item "image" }}
  {{ if eq (printf "%T" $image_raw) "string" }}{{ $image_name = strings.TrimSpace $image_raw }}{{ end }}
  {{/* Resolve image from page bundle, site assets, remote, or static URLs */}}
  {{ $image_resource := false }}
  {{ $image_url := "" }}
  {{ $image_path := "" }}
  {{ if $image_name }}
    {{ $image_path = strings.TrimSpace (printf "%v" $image_name) }}
    {{ $is_remote := or (strings.HasPrefix $image_path "http://") (strings.HasPrefix $image_path "https://") }}

    {{ if $is_remote }}
      {{ $remote := try (resources.GetRemote $image_path) }}
      {{ if and $remote (not $remote.Err) }}
        {{ $image_resource = $remote.Value }}
      {{ else }}
        {{ $image_url = $image_path }}
      {{ end }}
    {{ else }}
      {{ $image_path = strings.TrimPrefix "/" $image_path }}
      {{ $image_path = strings.TrimPrefix "./" $image_path }}
      {{ $image_path = strings.TrimPrefix "assets/" $image_path }}
      {{ $image_path = strings.TrimPrefix "media/" $image_path }}
      {{ $normalized := path.Clean $image_path }}

      {{ if and $normalized (ne $normalized ".") }}
        {{ with $page }}
          {{ $image_resource = (.Resources.ByType "image").GetMatch $normalized }}
        {{ end }}
        {{ if not $image_resource }}
          {{ $image_resource = resources.Get (path.Join "media" $normalized) }}
        {{ end }}
        {{ if not $image_resource }}
          {{ $image_url = printf "/media/%s" $normalized }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  
  {{ $image_to_render := $image_resource }}
  <div class="gap-8 items-center py-8 px-4 mx-auto max-w-screen-xl xl:gap-16 {{ if or $image_to_render $image_url }}md:grid md:grid-cols-2{{ end }} sm:py-16 lg:px-6">
    {{ if or $image_to_render $image_url }}
    {{ if $image_to_render }}
      {{ if ne $image_to_render.MediaType.SubType "gif" }}
        {{ $responsive := partial "functions/process_responsive_image.html" (dict 
            "image" $image_to_render 
            "mode" "fit"
            "sizes" (slice 400 600 800 1200)
        ) }}
        <img class="w-full" 
             srcset="{{ $responsive.srcset }}"
             sizes="(max-width: 768px) 100vw, 50vw"
             src="{{ $responsive.fallback.RelPermalink }}" 
             width="{{ $responsive.fallback.Width }}"
             height="{{ $responsive.fallback.Height }}"
             alt="{{$title | plainify}}" {{ if (modBool $idx 2)}}style="order: 1"{{end}}>
      {{ else }}
        <img class="w-full" 
             src="{{$image_to_render.RelPermalink}}" 
             width="{{$image_to_render.Width}}"
             height="{{$image_to_render.Height}}"
             alt="{{$title | plainify}}" {{ if (modBool $idx 2)}}style="order: 1"{{end}}>
      {{ end }}
    {{ else if $image_url }}
      {{ $is_external := or (strings.HasPrefix $image_url "http://") (strings.HasPrefix $image_url "https://") }}
      <img class="w-full" 
           src="{{ if $is_external }}{{ $image_url }}{{ else }}{{ $image_url | relURL }}{{ end }}"
           alt="{{$title | plainify}}" {{ if (modBool $idx 2)}}style="order: 1"{{end}}>
    {{ end }}
    {{ else if $image_name }}
      {{ warnf "%s uses the `cta-image-paragraph` blox which specifies a non-existent `image` at `assets/%s`. Rendering text only." $page.File.Path $image_path }}
    {{ end }}
    <div class="mt-4 md:mt-0">
      <h2 class="mb-4 text-4xl tracking-tight font-extrabold text-gray-900 dark:text-white">{{$title}}</h2>
      <p class="mb-6 font-light text-gray-500 md:text-lg dark:text-gray-400">{{$text}}</p>
      {{ $icon := "check" }}
      {{ $icon_raw := index $item "feature_icon" }}
      {{ if eq (printf "%T" $icon_raw) "string" }}{{ $icon = $icon_raw }}{{ end }}
      {{ $features_raw := index $item "features" }}
      {{ $features := slice }}
      {{ if reflect.IsSlice $features_raw }}
        {{ $features = $features_raw }}
      {{ else if eq (printf "%T" $features_raw) "string" }}
        {{ $features = slice $features_raw }}
      {{ end }}
      {{ if gt (len $features) 0 }}
      <ul>
        {{ range $features }}
        <li class="relative mb-4 pl-6">
          {{ partial "functions/get_icon" (dict "name" $icon "attributes" `class="inline-block pr-3" style="height: 1em;"`)  }}
          {{ printf "%v" . | markdownify }}
        </li>
        {{ end }}
      </ul>
      {{ end }}
      {{ $button_raw := index $item "button" }}
      {{ if and $button_raw (reflect.IsMap $button_raw) }}
      {{ $button_text := "" }}
      {{ $button_url := "" }}
      {{ with index $button_raw "text" }}{{ $button_text = strings.TrimSpace (printf "%v" .) }}{{ end }}
      {{ with index $button_raw "url" }}{{ $button_url = strings.TrimSpace (printf "%v" .) }}{{ end }}
      {{ if and $button_text $button_url }}
      {{ $link := $button_url }}
      {{ $target := "" }}
      {{ $scheme := (urls.Parse $link).Scheme }}
      {{ if not $scheme }}
        {{ if not (hasPrefix $link "#") }}
          {{ $link = $link | relLangURL }}
        {{ end }}
        {{ if eq (path.Ext $link) ".pdf" }}{{ $target = "target=\"_blank\" rel=\"noopener\"" }}{{ end }}
      {{ else if in (slice "http" "https") $scheme }}
        {{ $target = "target=\"_blank\" rel=\"noopener\"" }}
      {{ end }}
      <a href="{{ $link | safeURL }}" {{ $target | safeHTMLAttr }} class="mt-3 inline-flex items-center text-white bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:focus:ring-primary-900">
        {{ $button_text }}
        <svg class="ml-2 -mr-1 w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
      </a>
      {{ end }}
      {{ end }}
    </div>
  </div>
  {{ end }}
  {{ end }}
</div>
