{{/* Hugo Blox: Team Showcase */}}
{{/* Documentation: https://hugoblox.com/blocks/ */}}
{{/* License: https://github.com/HugoBlox/kit/blob/main/LICENSE.md */}}

{{/* Initialise */}}
{{ $page := .wcPage }}
{{ $block := .wcBlock }}
{{ $show_social := $block.design.show_social | default true }}
{{ $show_interests := $block.design.show_interests | default false }}
{{ $show_role := $block.design.show_role | default true }}
{{ $show_organizations := $block.design.show_organizations | default true }}
{{ $max_interests := $block.design.max_interests | default 3 }}
{{ $align := $block.design.align | default "center" }}
{{ $max_columns := $block.design.max_columns | default 4 }}
{{ $show_empty_groups := $block.design.show_empty_groups | default false }}
{{ $sort_field := $block.content.sort_by | default "name_family" }}
{{ $sort_asc := $block.content.sort_ascending | default true }}
{{ $sort_field_lc := lower $sort_field }}
{{ if hasPrefix $sort_field_lc "params." }}
  {{/* Backwards compatibility with Params.* used when authors were pages */}}
  {{ $sort_field = substr $sort_field 7 }}
  {{ $sort_field_lc = lower $sort_field }}
{{ end }}

{{ $title := $block.content.title | emojify | $page.RenderString }}
{{ $subtitle := $block.content.subtitle | emojify | $page.RenderString }}
{{ $text := $block.content.text | emojify | $page.RenderString }}
{{ $alignClass := cond (eq $align "left") "items-start text-left" "items-center text-center" }}
{{ $ctaAlignClass := cond (eq $align "left") "text-left" "text-center" }}

{{/* Safe numeric handling with clamping using type checks */}}
{{ $max_columns_int := 4 }}
{{ $max_columns_type := printf "%T" $max_columns }}
{{ if or (eq $max_columns_type "int") (eq $max_columns_type "int64") (eq $max_columns_type "float64") (eq $max_columns_type "float32") (eq $max_columns_type "uint") (eq $max_columns_type "uint64") }}
  {{ $max_columns_int = int $max_columns }}
{{ else if eq $max_columns_type "string" }}
  {{ if gt (len (findRE "^[0-9]+$" $max_columns)) 0 }}
    {{ $max_columns_int = int $max_columns }}
  {{ end }}
{{ end }}
{{ if lt $max_columns_int 2 }}{{ $max_columns_int = 2 }}{{ end }}
{{ if gt $max_columns_int 4 }}{{ $max_columns_int = 4 }}{{ end }}

{{ $max_interests_int := 3 }}
{{ $max_interests_type := printf "%T" $max_interests }}
{{ if or (eq $max_interests_type "int") (eq $max_interests_type "int64") (eq $max_interests_type "float64") (eq $max_interests_type "float32") (eq $max_interests_type "uint") (eq $max_interests_type "uint64") }}
  {{ $max_interests_int = int $max_interests }}
{{ else if eq $max_interests_type "string" }}
  {{ if gt (len (findRE "^[0-9]+$" $max_interests)) 0 }}
    {{ $max_interests_int = int $max_interests }}
  {{ end }}
{{ end }}
{{ if lt $max_interests_int 0 }}{{ $max_interests_int = 0 }}{{ end }}

{{ $columnsClasses := dict
  "2" "grid grid-cols-1 gap-8 sm:grid-cols-2"
  "3" "grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-3"
  "4" "grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"
}}
{{ $max_columns_key := printf "%d" $max_columns_int }}
{{ $gridClass := index $columnsClasses $max_columns_key | default "grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4" }}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
  
  {{/* Section Header */}}
  <div class="flex flex-col {{ $alignClass }} mb-12">
    {{ with $title }}
    <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-900 dark:text-white tracking-tight">
      {{ . }}
    </h2>
    {{ end }}
    
    {{ with $subtitle }}
    <p class="mt-4 text-xl text-gray-600 dark:text-gray-400">
      {{ . }}
    </p>
    {{ end }}
    
    {{ with $text }}
    <div class="mt-6 prose prose-lg lg:prose-xl dark:prose-invert max-w-3xl">
      {{ . }}
    </div>
    {{ end }}
  </div>

  {{/* Build profiles from data/authors */}}
  {{ $allProfiles := slice }}
  {{ range $slug, $_ := site.Data.authors }}
    {{ $profile := partial "functions/get_author_profile" (dict "slug" $slug) }}
    {{ $profileData := index site.Data.authors $slug }}
    {{ $allProfiles = $allProfiles | append (dict "profile" $profile "profileData" $profileData) }}
  {{ end }}

  {{ $groups := $block.content.user_groups }}

  {{ if $groups }}
    {{ range $i, $groupItem := $groups }}
      {{ $groupName := "" }}
      {{ $groupSortField := $sort_field }}
      {{ $groupSortAsc := $sort_asc }}
      {{ $groupSortFieldLc := "" }}
      {{ $itemIsMap := reflect.IsMap $groupItem }}
      {{ if $itemIsMap }}
        {{ $groupName = index $groupItem "name" | default (index $groupItem "title") | default "" }}
        {{ $groupSortField = index $groupItem "sort_by" | default $groupSortField }}
        {{ $groupSortAsc = index $groupItem "sort_ascending" | default $groupSortAsc }}
      {{ else }}
        {{ $groupName = $groupItem }}
      {{ end }}
      {{ if eq (trim $groupName " ") "" }}
        {{/* Skip groups with empty names to avoid matching everything */}}
        {{ continue }}
      {{ end }}
      {{ $groupSortFieldLc = lower $groupSortField }}
      {{ if hasPrefix $groupSortFieldLc "params." }}
        {{ $groupSortField = substr $groupSortField 7 }}
        {{ $groupSortFieldLc = lower $groupSortField }}
      {{ end }}
      {{ $groupIsNumeric := or (eq $groupSortFieldLc "weight") (eq $groupSortFieldLc "graduation_year") }}
      {{ $groupOrder := cond (and (not $groupIsNumeric) (not $groupSortAsc)) "desc" "asc" }}

      {{ $groupProfiles := slice }}
      {{ range $allProfiles }}
        {{ $profile := .profile }}
        {{ $uRaw := $profile.user_groups | default (slice) }}
        {{ $u := slice }}
        {{ range $uRaw }}
          {{ $u = $u | append (printf "%v" .) }}
        {{ end }}
        {{ if gt (len (intersect $u (slice (printf "%v" $groupName)))) 0 }}
          {{ $profileData := .profileData }}
          {{ $family := $profile.name_family_pref | default $profile.name_family | default (delimit (last 1 (split $profile.title " ")) "") | default $profile.title }}
          {{ $familyLower := lower $family }}
          {{ $raw := index $profile $groupSortField | default (index $profileData $groupSortField) }}
          {{ $rawType := printf "%T" $raw }}
          {{ $isNumeric := $groupIsNumeric }}
          {{ $primary := "" }}
          {{ if or (eq $groupSortFieldLc "name.family") (eq $groupSortFieldLc "family") (eq $groupSortFieldLc "last_name") (eq $groupSortFieldLc "name_family") (eq $groupSortFieldLc "family_name") }}
            {{ $primary = $familyLower }}
          {{ else if $isNumeric }}
            {{ $primary = 999999 }}
            {{ if or (eq $rawType "int") (eq $rawType "int64") (eq $rawType "float64") (eq $rawType "float32") (eq $rawType "uint") (eq $rawType "uint64") }}
              {{ $primary = int $raw }}
            {{ else if and (eq $rawType "string") (gt (len (findRE "^[0-9]+$" $raw)) 0) }}
              {{ $primary = int $raw }}
            {{ end }}
          {{ else if ne $raw nil }}
            {{ $primary = lower (printf "%v" $raw) }}
          {{ else }}
            {{ $primary = lower $profile.title }}
          {{ end }}
          {{ $sortKey := "" }}
          {{ if $isNumeric }}
            {{ $num := $primary | default 999999 }}
            {{ $sortKey = printf "%010d|%s" $num $familyLower }}
          {{ else }}
            {{ $sortKey = printf "%s|%s" $primary $familyLower }}
          {{ end }}
          {{ $groupProfiles = $groupProfiles | append (dict "profile" $profile "sort_val" $sortKey) }}
        {{ end }}
      {{ end }}
      {{ $groupProfiles = sort $groupProfiles "sort_val" $groupOrder }}

      {{ $hasGroupContent := or (gt (len $groupProfiles) 0) $show_empty_groups }}

      {{ if and $hasGroupContent (gt (len $groups) 1) }}
      <div class="col-span-full {{ if gt $i 0 }}mt-8 md:mt-10 lg:mt-12{{ end }} mb-4">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 pb-2 border-b border-gray-200 dark:border-gray-700">
          {{ $groupName | markdownify }}
        </h3>
      </div>
      {{ end }}

      {{ if $hasGroupContent }}
      <div class="{{ $gridClass }} w-full">
        {{ if eq (len $groupProfiles) 0 }}
          {{ if $show_empty_groups }}
          <div class="text-gray-600 dark:text-gray-400 py-6">{{ i18n "no_entries" | default "No entries yet." }}</div>
          {{ end }}
        {{ end }}
        {{ range $groupProfile := $groupProfiles }}
          {{ $profile := $groupProfile.profile }}
          {{ $avatar := $profile.avatar }}
          {{ $link := printf "/authors/%s/" $profile.slug }}
          {{ $nameSource := $profile.name_given | default $profile.title | default "?" }}
          {{ $initial := cond (gt (len $nameSource) 0) (upper (substr $nameSource 0 1)) "?" }}
          
          <div class="group relative">
            <div class="relative overflow-hidden rounded-2xl bg-white dark:bg-gray-800 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
              
              <a href="{{ $link }}" class="block relative h-64 overflow-hidden" aria-label="{{ $profile.title }}">
                {{ if $avatar }}
                  {{ $image := $avatar.Fill "400x400 Center webp" }}
                  <img src="{{ $image.RelPermalink }}" 
                       alt="{{ $profile.title }}" 
                       width="{{ $image.Width }}" 
                       height="{{ $image.Height }}" 
                       loading="lazy"
                       class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">
                  <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                {{ else }}
                  <div class="absolute inset-0 bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-4xl font-semibold text-gray-600 dark:text-gray-200">
                    {{ $initial }}
                  </div>
                {{ end }}
              </a>
              
              <div class="p-6">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-1">
                  <a href="{{ $link }}" class="hover:text-primary-600 dark:hover:text-primary-400 transition-colors" aria-label="{{ $profile.title }}">
                    {{ $profile.title }}
                  </a>
                </h3>
                
                {{ if $show_role }}
                <div class="text-gray-600 dark:text-gray-400 mb-3">
                  {{ $roleText := "" }}
                  {{ with $profile.role }}{{ $roleText = . }}{{ end }}
                  {{ if and (not $roleText) $profile.affiliations }}
                    {{ range first 1 $profile.affiliations }}
                      {{ $roleText = .name }}
                    {{ end }}
                  {{ end }}
                  {{ with $roleText }}<p class="font-medium">{{ . }}</p>{{ end }}
                  {{ if and $show_organizations $profile.affiliations }}
                    {{ range first 1 $profile.affiliations }}
                    <p class="text-sm mt-1">{{ .name }}</p>
                    {{ end }}
                  {{ end }}
                </div>
                {{ end }}
                
                {{ with $profile.bio }}
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4 line-clamp-2">
                  {{ . }}
                </p>
                {{ end }}
                
                {{ if and $show_interests $profile.interests }}
                <div class="mb-4">
                  <div class="flex flex-wrap gap-1">
                    {{ if gt $max_interests_int 0 }}
                      {{ range first $max_interests_int $profile.interests }}
                      <span class="inline-block bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs px-2 py-1 rounded">
                        {{ . }}
                      </span>
                      {{ end }}
                    {{ end }}
                  </div>
                </div>
                {{ end }}
                
                {{ if and $show_social $profile.links }}
                <div class="flex gap-3 pt-2 border-t border-gray-200 dark:border-gray-700">
                  {{ range $profile.links }}
                  {{ $l := .url | default .link }}
                  {{ $scheme := (urls.Parse $l).Scheme }}
                  {{ $target := "" }}
                  {{ if not $scheme }}
                    {{ $l = (.url | default .link) | relLangURL }}
                    {{ if eq (path.Ext $l) ".pdf" }}{{ $target = "target=\"_blank\" rel=\"noopener\"" }}{{ end }}
                  {{ else if in (slice "http" "https") $scheme }}
                    {{ $target = "target=\"_blank\" rel=\"noopener\"" }}
                  {{ end }}
                  
                  <a href="{{ $l | safeURL }}" 
                     {{ $target | safeHTMLAttr }} 
                     aria-label="{{ .icon }}"
                     {{ with .label }} title="{{ . }}"{{ end }}
                     class="text-gray-500 hover:text-primary-600 dark:text-gray-400 dark:hover:text-primary-400 transition-colors">
                    {{ partial "functions/get_icon" (dict "name" .icon "attributes" "class=\"w-5 h-5\"") }}
                  </a>
                  {{ end }}
                </div>
                {{ end }}
              </div>
            </div>
          </div>
        {{ end }}
      </div>
      {{ end }}
    {{ end }}
  {{ else }}
    {{ $isNumeric := or (eq $sort_field_lc "weight") (eq $sort_field_lc "graduation_year") }}
    {{ $order := cond (and (not $isNumeric) (not $sort_asc)) "desc" "asc" }}
    {{ $sorted := slice }}
    {{ range $allProfiles }}
      {{ $profile := .profile }}
      {{ $profileData := .profileData }}
      {{ $family := $profile.name_family_pref | default $profile.name_family | default (delimit (last 1 (split $profile.title " ")) "") | default $profile.title }}
      {{ $familyLower := lower $family }}
      {{ $raw := index $profile $sort_field | default (index $profileData $sort_field) }}
      {{ $rawType := printf "%T" $raw }}
      {{ $primary := "" }}
      {{ if or (eq $sort_field_lc "name.family") (eq $sort_field_lc "family") (eq $sort_field_lc "last_name") (eq $sort_field_lc "name_family") (eq $sort_field_lc "family_name") }}
        {{ $primary = $familyLower }}
      {{ else if $isNumeric }}
        {{ $primary = 999999 }}
        {{ if or (eq $rawType "int") (eq $rawType "int64") (eq $rawType "float64") (eq $rawType "float32") (eq $rawType "uint") (eq $rawType "uint64") }}
          {{ $primary = int $raw }}
        {{ else if and (eq $rawType "string") (gt (len (findRE "^[0-9]+$" $raw)) 0) }}
          {{ $primary = int $raw }}
        {{ end }}
      {{ else if ne $raw nil }}
        {{ $primary = lower (printf "%v" $raw) }}
      {{ else }}
        {{ $primary = lower $profile.title }}
      {{ end }}
      {{ $sortKey := "" }}
      {{ if $isNumeric }}
        {{ $num := $primary | default 999999 }}
        {{ $sortKey = printf "%010d|%s" $num $familyLower }}
      {{ else }}
        {{ $sortKey = printf "%s|%s" $primary $familyLower }}
      {{ end }}
      {{ $sorted = $sorted | append (dict "profile" $profile "sort_val" $sortKey) }}
    {{ end }}
    {{ $sorted = sort $sorted "sort_val" $order }}
    <div class="{{ $gridClass }}">
      {{ range $sortedProfile := $sorted }}
        {{ $profile := $sortedProfile.profile }}
        {{ $avatar := $profile.avatar }}
        {{ $link := printf "/authors/%s/" $profile.slug }}
        {{ $nameSource := $profile.name_given | default $profile.title | default "?" }}
        {{ $initial := cond (gt (len $nameSource) 0) (upper (substr $nameSource 0 1)) "?" }}
        <div class="group relative">
          <div class="relative overflow-hidden rounded-2xl bg-white dark:bg-gray-800 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
            <a href="{{ $link }}" class="block relative h-64 overflow-hidden" aria-label="{{ $profile.title }}">
              {{ if $avatar }}
              {{ $image := $avatar.Fill "400x400 Center webp" }}
              <img src="{{ $image.RelPermalink }}" 
                   alt="{{ $profile.title }}" 
                   width="{{ $image.Width }}" 
                   height="{{ $image.Height }}" 
                   loading="lazy"
                   class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">
              <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
              {{ else }}
              <div class="absolute inset-0 bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-4xl font-semibold text-gray-600 dark:text-gray-200">
                {{ $initial }}
              </div>
              {{ end }}
            </a>
            <div class="p-6">
              <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-1">
                <a href="{{ $link }}" class="hover:text-primary-600 dark:hover:text-primary-400 transition-colors" aria-label="{{ $profile.title }}">
                  {{ $profile.title }}
                </a>
              </h3>
              {{ if $show_role }}
              <div class="text-gray-600 dark:text-gray-400 mb-3">
                {{ with $profile.role }}<p class="font-medium">{{ . }}</p>{{ end }}
                {{ if and $show_organizations $profile.affiliations }}
                  {{ range first 1 $profile.affiliations }}
                  <p class="text-sm mt-1">{{ .name }}</p>
                  {{ end }}
                {{ end }}
              </div>
              {{ end }}
              {{ with $profile.bio }}
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-4 line-clamp-2">{{ . }}</p>
              {{ end }}
              {{ if and $show_interests $profile.interests }}
              <div class="mb-4">
                <div class="flex flex-wrap gap-1">
                  {{ if gt $max_interests_int 0 }}
                    {{ range first $max_interests_int $profile.interests }}
                    <span class="inline-block bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs px-2 py-1 rounded">{{ . }}</span>
                    {{ end }}
                  {{ end }}
                </div>
              </div>
              {{ end }}
              {{ if and $show_social $profile.links }}
              <div class="flex gap-3 pt-2 border-t border-gray-200 dark:border-gray-700">
                {{ range $profile.links }}
                {{ $l := .url | default .link }}
                {{ $scheme := (urls.Parse $l).Scheme }}
                {{ $target := "" }}
                {{ if not $scheme }}
                  {{ $l = (.url | default .link) | relLangURL }}
                  {{ if eq (path.Ext $l) ".pdf" }}{{ $target = "target=\"_blank\" rel=\"noopener\"" }}{{ end }}
                {{ else if in (slice "http" "https") $scheme }}
                  {{ $target = "target=\"_blank\" rel=\"noopener\"" }}
                {{ end }}
                <a href="{{ $l | safeURL }}" {{ $target | safeHTMLAttr }} aria-label="{{ .icon }}" {{ with .label }} title="{{ . }}"{{ end }} class="text-gray-500 hover:text-primary-600 dark:text-gray-400 dark:hover:text-primary-400 transition-colors">
                  {{ partial "functions/get_icon" (dict "name" .icon "attributes" "class=\"w-5 h-5\"") }}
                </a>
                {{ end }}
              </div>
              {{ end }}
            </div>
          </div>
        </div>
      {{ end }}
    </div>
  {{ end }}
  
  {{/* Call to Action */}}
  {{ with $block.content.cta }}
  <div class="mt-12 {{ $ctaAlignClass }}">
    <a href="{{ .url }}" class="inline-flex items-center px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg shadow-lg hover:shadow-xl transition-all duration-300">
      {{ .text }}
      {{ with .icon }}
      {{ partial "functions/get_icon" (dict "name" . "attributes" "class=\"ml-2 w-5 h-5\"") }}
      {{ end }}
    </a>
  </div>
  {{ end }}
  
</div>
